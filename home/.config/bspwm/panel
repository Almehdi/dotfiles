#!/bin/zsh


#if [ $(pgrep -cx panel) -gt 1 ] ; then
#    pkill panel
#    ./$0
#    printf "%s\n" "The panel is already running." >&2
#    exit 1
#fi

    trap 'trap - TERM; kill 0' INT TERM QUIT EXIT


. panel_colors

[ -e "$PANEL_FIFO" ] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"

function gmail() {
	email="$(sed -n '1p' <<<$(gpg -d $HOME/passw.asc 2&> /dev/null))"
	passw="$(sed -n '2p' <<<$(gpg -d $HOME/passw.asc 2&> /dev/null))"
	while true
	do
		inbox_count=$(wget -q -O- --auth-no-challenge --user=${email} --password=${passw} 'https://mail.google.com/mail/feed/atom' | awk -F'<\/?fullcount>' '{print $2}' 2&> /dev/null)
		echo "G:$inbox_count"
		sleep 60
	done
}

function weather() {
	while true
	do
		weather_stat=$($HOME/.config/scripts/./weather-yr.sh)
		echo "F$weather_stat"
		sleep 900
	done
}

function time_date() {
	while true
	do
		klocka=$(date +'%A %d %B w%V  %H:%M')
		echo "C$klocka"
		sleep 10
	done < <(echo)
}

#bspc config top_padding $PANEL_HEIGHT
#bspc control --put-status &
bspc control --subscribe > "$PANEL_FIFO" &
xtitle -sf "T%s" > "$PANEL_FIFO" &
weather > "$PANEL_FIFO" &
gmail > "$PANEL_FIFO" &
time_date > "$PANEL_FIFO" &

        PANEL_HEIGHT=14
        PANEL_FONT_FAMILY='Meiryo'
        PANEL_FONT_SIZE=9

cat "$PANEL_FIFO" | panel_dzen2 -f "$PANEL_FONT_FAMILY" -s "$PANEL_FONT_SIZE" -F \
"$PANEL_ICONS_FONT_FAMILY" -S "$PANEL_ICONS_FONT_SIZE" | dzen2 -h $PANEL_HEIGHT \
-dock -ta l -title-name panel -fn "${PANEL_FONT_FAMILY}:pixelsize=${PANEL_FONT_SIZE}" -fg \
"$COLOR_FOREGROUND" -bg "$COLOR_BACKGROUND"
